<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CleanSlateAI — Debt Clarity (MVP)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; padding: 24px; background:#0b0b0b; color:#f5f5f5; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 26px; }
    .sub { margin: 0 0 18px; color:#bdbdbd; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background:#141414; border:1px solid #2a2a2a; border-radius: 14px; padding: 16px; }
    label { display:block; font-size: 12px; color:#bdbdbd; margin-bottom: 6px; }
    input, textarea { width: 100%; box-sizing: border-box; border-radius: 10px; border:1px solid #2a2a2a; background:#0f0f0f; color:#f5f5f5; padding: 10px; }
    textarea { min-height: 200px; resize: vertical; }
    .row { display:flex; gap: 10px; }
    .row > div { flex: 1; }
    button { width: 100%; border:0; border-radius: 12px; padding: 12px; background:#f5f5f5; color:#0b0b0b; font-weight: 700; cursor:pointer; }
    button:disabled { opacity: .6; cursor:not-allowed; }
    .muted { color:#bdbdbd; font-size: 12px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; border:1px solid #2a2a2a; background:#0f0f0f; font-size: 12px; color:#d7d7d7; }
    .k { color:#bdbdbd; font-size: 12px; }
    .v { font-size: 14px; }
    .hr { height:1px; background:#2a2a2a; margin: 12px 0; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0f0f0f; border:1px solid #2a2a2a; padding: 12px; border-radius: 12px; font-size: 12px; color:#dcdcdc; overflow:auto; }
    .ok { color:#7CFC98; }
    .warn { color:#FFD479; }
    .err { color:#FF7B7B; }
    ul { margin: 8px 0 0 18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CleanSlateAI — Debt Clarity MVP</h1>
    <p class="sub">Paste any debt/collection messages. Get a calm summary + next steps + scripts.</p>

    <div class="grid">
      <div class="card">
        <label for="rawText">Paste messages (SMS/WhatsApp/Email text)</label>
        <textarea id="rawText" placeholder="Paste here..."></textarea>

        <div class="row" style="margin-top:12px;">
          <div>
            <label for="salary">Salary (number)</label>
            <input id="salary" inputmode="numeric" placeholder="e.g., 9000" />
          </div>
          <div>
            <label for="essentials">Essentials (number)</label>
            <input id="essentials" inputmode="numeric" placeholder="e.g., 6000" />
          </div>
        </div>

        <div style="margin-top:12px;">
          <button id="btn" onclick="run()">Generate plan</button>
          <p class="muted" id="status" style="margin-top:10px;"></p>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div>
            <div class="k">Status</div>
            <div class="v"><span class="pill" id="pill">—</span></div>
          </div>
          <div>
            <div class="k">Stability score</div>
            <div class="v"><span class="pill" id="score">—</span></div>
          </div>
          <div>
            <div class="k">Legal risk</div>
            <div class="v"><span class="pill" id="risk">—</span></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="k">Plain English</div>
        <div class="v" id="plain">—</div>

        <div class="hr"></div>

        <div class="k">What to do first</div>
        <div class="v" id="first">—</div>

        <div class="hr"></div>

        <div class="k">Why this matters</div>
        <div class="v" id="why">—</div>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <div class="k">Debts found</div>
        <div id="debts">—</div>

        <div class="hr"></div>

        <div class="k">Collection messages</div>
        <div id="msgs">—</div>
      </div>

      <div class="card">
        <div class="k">Next 7 days plan</div>
        <div id="plan">—</div>

        <div class="hr"></div>

        <div class="k">Negotiation scripts</div>
        <div id="scripts">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="k">Raw JSON (for debugging)</div>
      <pre id="json">—</pre>
    </div>
  </div>

<script>
  function numOrNull(v){
    if (v === "" || v === null || v === undefined) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function esc(s){
    return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  async function run(){
    const btn = document.getElementById("btn");
    const status = document.getElementById("status");
    btn.disabled = true;
    status.textContent = "Working…";

    const rawText = document.getElementById("rawText").value.trim();
    const salary = numOrNull(document.getElementById("salary").value.trim());
    const essentials = numOrNull(document.getElementById("essentials").value.trim());

    if(!rawText){
      status.innerHTML = '<span class="err">Please paste some text first.</span>';
      btn.disabled = false;
      return;
    }

    try{
      const res = await fetch("/api/generate-plan", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ rawText, salary, essentials })
      });

      const data = await res.json().catch(() => null);

      if(!res.ok){
        status.innerHTML = '<span class="err">Error from server:</span> ' + esc(JSON.stringify(data || {status:res.status}, null, 2));
        btn.disabled = false;
        return;
      }

      status.innerHTML = '<span class="ok">Done.</span>';
      render(data);
    }catch(e){
      status.innerHTML = '<span class="err">Network or runtime error:</span> ' + esc(e.message || String(e));
    }finally{
      btn.disabled = false;
    }
  }

  function render(d){
    document.getElementById("pill").textContent = d?.calm_summary?.status || "—";
    document.getElementById("score").textContent = (d?.risk_assessment?.stability_score_0_to_100 ?? "—");
    document.getElementById("risk").textContent = d?.risk_assessment?.immediate_legal_risk || "—";

    document.getElementById("plain").textContent = d?.calm_summary?.plain_english || "—";
    document.getElementById("first").textContent = d?.calm_summary?.what_to_do_first || "—";
    document.getElementById("why").textContent = d?.calm_summary?.why_this_matters || "—";

    // debts
    const debts = (d?.extracted?.debts || []);
    document.getElementById("debts").innerHTML = debts.length
      ? "<ul>" + debts.map(x => {
          const min = x.minimum_due === null ? "—" : x.minimum_due;
          const tot = x.total_due === null ? "—" : x.total_due;
          return `<li><b>${esc(x.account_name)}</b> (${esc(x.type)}) — min: <b>${esc(min)}</b>, total: <b>${esc(tot)}</b> ${x.currency ? esc(x.currency) : ""}</li>`;
        }).join("") + "</ul>"
      : "—";

    // messages
    const msgs = (d?.extracted?.collection_messages || []);
    document.getElementById("msgs").innerHTML = msgs.length
      ? "<ul>" + msgs.map(m => `<li><b>${esc(m.risk_tag)}</b>: ${esc(m.text)} <span class="muted">(${esc(m.note)})</span></li>`).join("") + "</ul>"
      : "—";

    // plan
    const plan = (d?.next_7_days_plan || []);
    document.getElementById("plan").innerHTML = plan.length
      ? "<ul>" + plan.map(p => `<li><b>Day ${esc(p.day)}</b>: ${esc(p.action)} <span class="muted">— ${esc(p.reason)}</span>${p.estimated_cost !== null ? ` <span class="pill">cost: ${esc(p.estimated_cost)}</span>` : ""}</li>`).join("") + "</ul>"
      : "—";

    // scripts
    const scripts = d?.negotiation_scripts || {};
    const keys = Object.keys(scripts);
    let html = "";
    for(const k of keys){
      const s = scripts[k];
      html += `<div style="margin-bottom:12px;"><div class="pill">${esc(k)}</div>`;
      html += `<div class="muted" style="margin-top:6px;">When to contact: ${esc(s.when_to_contact || "—")}</div>`;
      html += `<div style="margin-top:6px;"><b>What to say</b><ul>${(s.what_to_say||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul></div>`;
      html += `<div style="margin-top:6px;"><b>What NOT to say</b><ul>${(s.what_not_to_say||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul></div>`;
      html += `<div class="muted">Follow up window (days): ${esc(s.follow_up_window_days ?? "—")}</div>`;
      html += `</div>`;
    }
    document.getElementById("scripts").innerHTML = html || "—";

    // json
    document.getElementById("json").textContent = JSON.stringify(d, null, 2);
  }
</script>

</body>
</html>
